# 拉起前置准备
1. 物料、环境准备
2. Gaia 支撑环境 安装
3. yum imgcache 部署
4. Gaia 部署方案（资源与服务的对应关系表）
5. 弹性交付（拉管控）部署节点需要满足
  > 可以运行 kubectl
  > 磁盘容量大于 1T (镜像包大小)
6. (按照客户方案)所有 node 节点打标签
  >没有占用 28080, 8001, 8440, 8441的node节点，还要打csp的标签：kubectl label nodes ${hostname} module=csp
7. 所有 node 节点配置nameserver 为 kube-dns 的 svc ip(192.168.192.2)
8. 检查 CKV 的 redis 实例是否有 redis-cas 账户（密码为 redis）

# 物料说明
1. 下载物料（原料：ted_raw_xxx.tar.gz download_raw_xxx.sh）
> tar -zxf ted_raw_xxx.tar.gz -C /data --> 产生 /data/ted_raw 目录
> cp download_raw_xxx.sh /data/ted_raw
> cd /data/ted_raw && bash download_raw_xx.sh
> 以上步骤生成部署所需的物料包 /data/ted_raw/*，部署时将其带到现场

2. 
> 将部署物料包放于部署节点的 /data/tce_ted_install/ 目录下 
> 物料包分为两部分： 
  > /data/tce_ted_install/ted_raw/ocloud(目录下主要为支撑组件和Gaia物料包)
    > ocloud/gaia-tce(cdb ansible tdcos)
  > /data/tce_ted_install/ted_raw/tcloud(目录下主要为 管控相关物料)
    > passage.tar.gz(images deploy.git.tar.gz kubedns.tar.gz tce-gaiastack-transfer)

# 管控拉起（前置阶段）
> 如果没有 /data/tce-gaiastack-transfer 目录
> 需要将 /data/tce_ted_install/ted_raw/ocloud/tce-gaiastack-transfer 目录复制到 /data 目录下
## 物料分发

## kubedns 安装
> 如果没有 /data/tce-gaiastack-transfer/ocloud 则需要先新建目录
1. 将 kubedns.tar.gz 解压至 /data/tce-gaiastack-transfer/ocloud 目录下
2. 执行安装 cd /data/tce-gaiastack-transfer/ocloud/kubedns && bash deploy-kubedns.sh

## passage 安装
1. 修改 /data/tce-gaiastack-transfer/cluster_info.ini
2. 创建 passage 的配置文件 vim /data/tce-gaiastack-transfer/passage_conf.json
3. 安装依赖项 PyYAML cd /data/tce-gaiastack-transfer/PyYAML-3.12 && python setup.py install
4. 将 passage.tar.gz 解压至 /data/tce-gaiastack-transfer/ocloud 目录
5. 执行 
> bash /data/tce_ted_install/ted_raw/ocloud/ted-tools/passage-images/load_images.sh
6. 移动部署脚本
> mv /data/tce-gaiastack-transfer/ocloud/passage/src/script/deploy_passage.py /data/tce-gaiastack-transfer/ 
7. 执行部署脚本 
> cd /data/tce-gaiastack-transfer 
> python deploy_passage.py --config passage_conf.json --dbInit 1
8. 录入各组件资源分配
> cd /data/tce-gaiastack-transfer
> python app_view_tool.py --type resource_insert_ted --resourceList resource_template_nolimit.list --nodeNumBase 3 --nodeNumReal ${实际的 gaia-node 的数量} --cleanOld 1

## 填写配置（可以与导入镜像并行执行）
1. 将 deploy.git.tar.gz 解压至 /data 目录下
> config.csv
> config.env 环境配置
> config.ext 产品配置，客户配置
2. 加载配置
> cd /data/deploy.git && bash  ./script/reload_config.sh

## 导入镜像(/data/tce_ted_install/ted_raw/images)
1. 准备版本信息
2. 检查镜像
> 先将最新的镜像列表 modlist.latest.xxx 拷贝至 /data/tce_ted_install/ted_raw/images/${version}/ 目录下并重命名为 modlist.latest
> 执行 cd /data/deploy.git && ./script/check_images.sh
3. 导入镜像
> cd /data/deploy.git && ./script/load_images.sh 
> 导入完成后，反复执行 ./script/load_images.sh check 直到没有新的镜像位置
> 最后 执行 ./script/load_images push
4. 检查导入情况
> 正常导入 /data/deploy.git 目录下应该生成一个到 /data/tce_ted_install/images/${version} 目录的软连接 ted_latest

## FakeTGW(TGW容器起来前代替使用)
> 首先需要 从 config.csv 文件中获取 @zk346_vip_2181@ @gaia_node1@
> 前者作为 ${fake_ip}:${fake_port}
> 后者作为 ${gaia_node1}
> 使用 ssh 隧道在FakeTGW机器上添加转发规则
1. 修改 FakeTGw 机器的 /etc/ssh/sshd_config 添加
> AllowTcpForwarding yes
> PermitTunnel yes
> 重启 sshd 服务
2. FakeTGW 机器上添加环境变量,并设置本机到本机的 ssh 免密登录
> export fake_ip="${fake_ip}“
> export fake_port=36000
> export gaia_node1="${gaia_node1}"

> ssh-keygen -t rsa ssh-copy-id root@${fake_ip} -p ${fake_port}
> 然后在 fake_ip 上执行
```
#ZK
ssh -Nf4L 0.0.0.0:2012:${fake_ip}:2181  ${fake_ip}  -p ${fake_port}
#account.tencentyun.com
ssh -Nf4L 0.0.0.0:50001:${gaia_node1}:80 ${fake_ip} -p ${fake_port} 
#auth.cam
ssh -Nf4L 0.0.0.0:9502:${gaia_node1}:80 ${fake_ip} -p ${fake_port} 

#dns 高可用
ssh -Nf4L 0.0.0.0:80:${gaia_node1}:80 ${fake_ip} -p ${fake_port} 
#dcos
ssh -Nf4L 0.0.0.0:6613:${gaia_node1}:6613 ${fake_ip} -p ${fake_port} 
ssh -Nf4L 0.0.0.0:6641:${gaia_node1}:6641 ${fake_ip} -p ${fake_port} 
ssh -Nf4L 0.0.0.0:6605:${gaia_node1}:6605 ${fake_ip} -p ${fake_port} 

#(v3.3.1) 新增一条 faketgw（来自 ninghuang） grant2.cam.tencentyun.com
ssh -Nf4L 0.0.0.0:50022:${gaia_node1}:80 ${fake_ip} -p ${fake_port} 
```

# 拉起管控(开始部署)
` cd /data/deploy.git && bash ./script/install.sh all`
> 注：此过程比较久，为了方便跟进，所以使用 screen 工具，后续可以使用 screen -x deploy 查看。
> log/install-*.log 里面看到执行过程的 Log，请重点关注前 3 步有没有报错。
> script/init_check.sh 可以查看初始化进展，null 开头的表示初始化没有完成。

# 部署客制化系统